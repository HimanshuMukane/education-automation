<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="{{ url_for('static', filename='css/admin.css') }}" rel="stylesheet" />
</head>

<body class="d-flex">
  <!-- Sidebar -->
  <div class="sidebar d-none d-md-block">
    {% include '_partials/_sidebar.html' %}
  </div>

  <!-- Mobile Navigation -->
  <nav class="navbar navbar-dark bg-dark d-md-none fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Admin Dashboard</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileSidebar">
        <span class="navbar-toggler-icon"></span>
      </button>
    </div>
  </nav>

  <!-- Mobile Sidebar -->
  <div class="offcanvas offcanvas-start d-md-none" id="mobileSidebar">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title">Menu</h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      {% include '_partials/_sidebar.html' %}
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content flex-grow-1">
    <div class="container-fluid">
      <!-- Welcome Section -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h1 class="h3">Level-1 Admin Dashboard</h1>
          <p class="text-muted">Welcome, {{ session.user.name }}!</p>
        </div>
        <div class="d-none d-md-block">
          <span class="text-muted">{{ current_date }}</span>
        </div>
      </div>

      <!-- Create Teacher Card -->
      <div class="card mb-4 shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Create Teacher Account</span>
          <button class="btn btn-sm btn-outline-light" type="button" data-bs-toggle="collapse"
            data-bs-target="#createTeacherForm">
            <i class="bi bi-plus-lg"></i>
          </button>
        </div>
        <div class="card-body collapse show" id="createTeacherForm">
          <form id="createTeacherForm">
            <div class="row g-3">
              <div class="col-md-6">
                <label for="teacherName" class="form-label">Name</label>
                <input type="text" class="form-control" id="teacherName" placeholder="Teacher full name" required />
              </div>
              <div class="col-md-6">
                <label for="teacherEmail" class="form-label">Email</label>
                <input type="email" class="form-control" id="teacherEmail" placeholder="teacher@example.com" required />
              </div>
              <div class="col-md-6">
                <label for="teacherPassword" class="form-label">Password</label>
                <div class="input-group">
                  <input type="password" class="form-control" id="teacherPassword" placeholder="Enter a password"
                    required />
                  <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('teacherPassword')">
                    <i class="bi bi-eye"></i>
                  </button>
                </div>
              </div>
              <div class="col-md-6">
                <label for="teacherPay" class="form-label">Pay per Lecture (₹)</label>
                <input type="number" step="0.01" class="form-control" id="teacherPay" placeholder="e.g. 250.00"
                  required />
              </div>
            </div>
            <div class="mt-3">
              <button type="submit" class="btn btn-success">
                <i class="bi bi-person-plus-fill me-2"></i>Create Teacher
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Teachers List -->
      <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Existing Teachers</span>
          <div class="d-flex gap-2">
            <input type="text" class="form-control form-control-sm" id="teacherSearch" placeholder="Search teachers...">
            <select class="form-select form-select-sm" id="teacherSort">
              <option value="name">Sort by Name</option>
              <option value="email">Sort by Email</option>
              <option value="pay">Sort by Pay</option>
            </select>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Pay/Lecture</th>
                  <th class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody id="teachersTableBody">
                {% for teacher in teachers %}
                <tr data-teacher-id="{{ teacher.id }}" data-teacher-name="{{ teacher.name }}"
                  data-teacher-email="{{ teacher.email }}" data-teacher-pay="{{ teacher.pay_per_lecture }}">
                  <td>{{ teacher.id }}</td>
                  <td class="teacher-name">{{ teacher.name }}</td>
                  <td class="teacher-email">{{ teacher.email }}</td>
                  <td class="teacher-pay">₹{{ teacher.pay_per_lecture }}</td>
                  <td class="text-end">
                    <button class="btn btn-sm btn-primary edit-teacher-btn">
                      <i class="bi bi-pencil-square"></i>
                    </button>
                    <button class="btn btn-sm btn-danger delete-teacher-btn">
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal fade" id="editTeacherModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form id="editTeacherForm">
          <div class="modal-header">
            <h5 class="modal-title">Edit Teacher</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div id="editFeedback" class="mb-2"></div>
            <input type="hidden" id="editTeacherId" />
            <div class="mb-3">
              <label for="editTeacherName" class="form-label">Name</label>
              <input type="text" class="form-control" id="editTeacherName" required />
            </div>
            <div class="mb-3">
              <label for="editTeacherEmail" class="form-label">Email</label>
              <input type="email" class="form-control" id="editTeacherEmail" required />
            </div>
            <div class="mb-3">
              <label for="editTeacherPay" class="form-label">Pay per Lecture (₹)</label>
              <input type="number" step="0.01" class="form-control" id="editTeacherPay" required />
            </div>
            <div class="mb-3">
              <label for="editTeacherPassword" class="form-label">New Password</label>
              <div class="input-group">
                <input type="password" class="form-control" id="editTeacherPassword"
                  placeholder="Leave blank to keep current" />
                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('editTeacherPassword')">
                  <i class="bi bi-eye"></i>
                </button>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Delete Modal -->
  <div class="modal fade" id="deleteTeacherModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirm Deletion</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="text-center mb-3">
            <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
          </div>
          <p class="text-center" id="deleteModalBodyText">Are you sure you want to delete this teacher?</p>
          <div id="deleteFeedback" class="mt-2"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" id="confirmDeleteBtn" class="btn btn-danger">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Password toggle function
    function togglePassword(inputId) {
      const input = document.getElementById(inputId);
      const icon = input.nextElementSibling.querySelector('i');
      if (input.type === 'password') {
        input.type = 'text';
        icon.classList.replace('bi-eye', 'bi-eye-slash');
      } else {
        input.type = 'password';
        icon.classList.replace('bi-eye-slash', 'bi-eye');
      }
    }

    // Search functionality
    document.getElementById('teacherSearch').addEventListener('input', function (e) {
      const searchTerm = e.target.value.toLowerCase();
      const rows = document.querySelectorAll('#teachersTableBody tr');

      rows.forEach(row => {
        const name = row.querySelector('.teacher-name').textContent.toLowerCase();
        const email = row.querySelector('.teacher-email').textContent.toLowerCase();
        const shouldShow = name.includes(searchTerm) || email.includes(searchTerm);
        row.style.display = shouldShow ? '' : 'none';
      });
    });

    // Sort functionality
    document.getElementById('teacherSort').addEventListener('change', function (e) {
      const sortBy = e.target.value;
      const tbody = document.getElementById('teachersTableBody');
      const rows = Array.from(tbody.querySelectorAll('tr'));

      rows.sort((a, b) => {
        let aVal = a.querySelector(`.teacher-${sortBy}`).textContent;
        let bVal = b.querySelector(`.teacher-${sortBy}`).textContent;

        if (sortBy === 'pay') {
          aVal = parseFloat(aVal.replace('₹', ''));
          bVal = parseFloat(bVal.replace('₹', ''));
          return bVal - aVal;
        }

        return aVal.localeCompare(bVal);
      });

      rows.forEach(row => tbody.appendChild(row));
    });
  </script>

  <!-- Keep existing JavaScript for CRUD operations -->
  <script>
    // ── CREATE TEACHER (unchanged) ───────────────────────────────────────────────
    document
      .getElementById("createTeacherForm")
      .addEventListener("submit", function (e) {
        e.preventDefault();

        const name = document
          .getElementById("teacherName")
          .value.trim();
        const email = document
          .getElementById("teacherEmail")
          .value.trim()
          .toLowerCase();
        const password = document.getElementById("teacherPassword").value;
        const payRaw = document.getElementById("teacherPay").value;

        if (!name || !email || !password || !payRaw) {
          showCreateFeedback(
            "All fields (Name, Email, Password, Pay per Lecture) are required.",
            false
          );
          return;
        }

        const pay_per_lecture = parseFloat(payRaw);
        if (isNaN(pay_per_lecture) || pay_per_lecture < 0) {
          showCreateFeedback(
            "Please enter a valid, non-negative number for Pay per Lecture.",
            false
          );
          return;
        }

        fetch("/admin/teacher/create", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            name,
            email,
            password,
            pay_per_lecture,
          }),
        })
          .then((res) =>
            res.json().then((data) => ({
              status: res.status,
              body: data,
            }))

          )
          .then(({ status, body }) => {

            if (status === 200 && body.success) {
              showCreateFeedback(body.message, true);
              prependTeacherRow(body.teacher);
              //document.getElementById("createTeacherForm").reset();
            } else {
              showCreateFeedback(body.error || "Failed to create teacher.", false);
            }
          })
          .catch((err) => {
            console.error(err);
            showCreateFeedback("An unexpected error occurred.", false);
          });
      });

    function showCreateFeedback(msg, isSuccess) {
      let alertClass = isSuccess ? "alert-success" : "alert-danger";
      let feedbackDiv = document.getElementById("createFeedback");
      if (!feedbackDiv) {
        // first time – insert a feedback <div> right above the form
        feedbackDiv = document.createElement("div");
        feedbackDiv.id = "createFeedback";
        const form = document.getElementById("createTeacherForm");
        form.parentNode.insertBefore(feedbackDiv, form);
      }
      feedbackDiv.className = `alert ${alertClass} mt-2`;
      feedbackDiv.textContent = msg;
      if (isSuccess) {
        setTimeout(() => {
          feedbackDiv.remove();
        }, 3000);
      }
    }

    function prependTeacherRow(teacher) {
      const tbody = document.getElementById("teachersTableBody");
      const tr = document.createElement("tr");
      tr.setAttribute("data-teacher-id", teacher.id);
      tr.setAttribute("data-teacher-name", teacher.name);
      tr.setAttribute("data-teacher-email", teacher.email);
      tr.setAttribute("data-teacher-pay", teacher.pay_per_lecture);
      tr.innerHTML = `
        <td>${teacher.id}</td>
        <td class="teacher-name">${teacher.name}</td>
        <td class="teacher-email">${teacher.email}</td>
        <td class="teacher-pay">${teacher.pay_per_lecture}</td>
        <td>
          <button class="btn btn-sm btn-primary edit-teacher-btn">Edit</button>
          <button class="btn btn-sm btn-danger delete-teacher-btn">Delete</button>
        </td>`;
      tbody.prepend(tr);
    }

    // ── EDIT / DELETE event delegation ───────────────────────────────────────────
    const teachersTbody = document.getElementById("teachersTableBody");
    teachersTbody.addEventListener("click", function (e) {
      const row = e.target.closest("tr");
      const teacherId = row?.getAttribute("data-teacher-id");
      if (!teacherId) return;

      // ── DELETE button clicked → show Delete Modal ───────────────────────────
      if (e.target.classList.contains("delete-teacher-btn")) {
        const teacherName = row.getAttribute("data-teacher-name") || "";
        openDeleteModal(teacherId, teacherName);
      }

      // ── EDIT button clicked → show Edit Modal ───────────────────────────────
      if (e.target.classList.contains("edit-teacher-btn")) {
        const tName = row.getAttribute("data-teacher-name");
        const tEmail = row.getAttribute("data-teacher-email");
        const tPay = row.getAttribute("data-teacher-pay");
        openEditModal(teacherId, tName, tEmail, tPay);
      }
    });

    // ── EDIT MODAL logic ───────────────────────────────────────────────────────
    let editModal = new bootstrap.Modal(document.getElementById("editTeacherModal"));
    function openEditModal(id, name, email, pay) {
      document.getElementById("editTeacherId").value = id;
      document.getElementById("editTeacherName").value = name;
      document.getElementById("editTeacherEmail").value = email;
      document.getElementById("editTeacherPay").value = pay;
      document.getElementById("editTeacherPassword").value = "";
      document.getElementById("editFeedback").innerHTML = ""; // clear previous feedback
      editModal.show();
    }

    document.getElementById("editTeacherForm").addEventListener("submit", function (e) {
      e.preventDefault();
      const id = document.getElementById("editTeacherId").value;
      const newName = document.getElementById("editTeacherName").value.trim();
      const newEmail = document.getElementById("editTeacherEmail").value.trim().toLowerCase();
      const newPayRaw = document.getElementById("editTeacherPay").value;
      const newPwd = document.getElementById("editTeacherPassword").value;

      if (!newName || !newEmail || !newPayRaw) {
        showEditFeedback("Name, Email, and Pay per Lecture are required.", false);
        return;
      }

      const newPay = parseFloat(newPayRaw);
      if (isNaN(newPay) || newPay < 0) {
        showEditFeedback("Please enter a valid, non-negative number for Pay per Lecture.", false);
        return;
      }

      let payload = { name: newName, email: newEmail, pay_per_lecture: newPay, id: id };
      if (newPwd.trim()) {
        payload.password = newPwd;
      }

      fetch(`{{url_for("admin.modify_teacher")}}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      })
        .then((res) =>
          res.json().then((data) => ({
            status: res.status,
            body: data,
          }))
        )
        .then(({ status, body }) => {
          if (status === 200 && body.success) {
            showEditFeedback(body.message, true);
            // Update the table row values & data-attributes
            const row = document.querySelector(`tr[data-teacher-id="${id}"]`);
            row.setAttribute("data-teacher-name", body.teacher.name);
            row.setAttribute("data-teacher-email", body.teacher.email);
            row.setAttribute("data-teacher-pay", +body.teacher.pay_per_lecture);
            row.querySelector(".teacher-name").textContent = body.teacher.name;
            row.querySelector(".teacher-email").textContent = body.teacher.email;
            row.querySelector(".teacher-pay").textContent = "₹" + parseFloat(body.teacher.pay_per_lecture);
            // NOT GETTING FLOAT VALUE AFTER UPDATE
            setTimeout(() => {
              editModal.hide();
            }, 500);
          } else {
            showEditFeedback(body.error || "Failed to update.", false);
          }
        })
        .catch((err) => {
          console.error(err);
          showEditFeedback("An unexpected error occurred.", false);
        });
    });

    function showEditFeedback(msg, isSuccess) {
      const fb = document.getElementById("editFeedback");
      fb.innerHTML = `<div class="alert ${isSuccess ? "alert-success" : "alert-danger"}">
                        ${msg}
                      </div>`;
      if (isSuccess) {
        setTimeout(() => {
          fb.innerHTML = "";
        }, 3000);
      }
    }

    // ── DELETE MODAL logic ─────────────────────────────────────────────────────
    let deleteModal = new bootstrap.Modal(document.getElementById("deleteTeacherModal"));
    let deletingTeacherId = null;

    function openDeleteModal(id, name) {
      deletingTeacherId = id;
      document.getElementById("deleteFeedback").innerHTML = "";
      document.getElementById("deleteModalBodyText").textContent =
        `Are you sure you want to delete "${name}" (ID #${id})?`;
      deleteModal.show();
    }

    document.getElementById("confirmDeleteBtn").addEventListener("click", function () {
      if (!deletingTeacherId) return;

      fetch(`{{admin.modify_teacher}}`, {
        method: "DELETE",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ "id": deletingTeacherId })
      })
        .then((res) =>
          res.json().then((data) => ({
            status: res.status,
            body: data,
          }))
        )
        .then(({ status, body }) => {
          if (status === 200 && body.success) {
            document.querySelector(`tr[data-teacher-id="${deletingTeacherId}"]`).remove();
            showDeleteFeedback(body.message, true);
            setTimeout(() => {
              deleteModal.hide();
            }, 1000);
          } else {
            showDeleteFeedback(body.error || "Failed to delete.", false);
          }
        })
        .catch((err) => {
          console.error(err);
          showDeleteFeedback("An unexpected error occurred.", false);
        });
    });

    function showDeleteFeedback(msg, isSuccess) {
      const fb = document.getElementById("deleteFeedback");
      fb.innerHTML = `<div class="alert ${isSuccess ? "alert-success" : "alert-danger"}">
                        ${msg}
                      </div>`;
      if (isSuccess) {
        setTimeout(() => {
          fb.innerHTML = "";
        }, 3000);
      }
    }
  </script>
</body>

</html>